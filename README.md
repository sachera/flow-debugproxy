Flow Framework Debug Proxy for xDebug
-------------------------------------

Flow Framework is a web application platform enabling developers creating
excellent web solutions and bring back the joy of coding. It gives you fast
results. It is a reliable foundation for complex applications.

The biggest pain with Flow Framework come from the the proxy class, the
framework do not execute your own code, but a precompiled version. This is
required for advanced feature, like AOP and the security framework. So working
with Flow is a real pleasure, but adding xDebug in the setup can be a pain.

This project is an xDebug proxy, written in Go, to take care of the mapping
between your PHP file and the proxy class.

Build your own
--------------

When you just want to use this inside Docker you probably want to scroll further down and skip until you reach the **Use with Docker** part. No need to build it on your host machine yourself.

    # Get the dependecies
    go get
    # Build
    go build

Run the proxy
-------------

    # Don't forget to change the configuration of your IDE to use port 9010
    flow-debugproxy -vv --framework flow

How to debug the proxy class directly
-------------------------------------

You can disable to path mapping, in this case the proxy do not process xDebug
protocol:

    ./flow-debugproxy --framework dummy

Show help
---------

    ./flow-debugproxy help

Use with Docker
---------------

Make sure xdebug is installed in your dev container. You can use drydock for this or add the following to your development Dockerfile

```
# install xdebug
RUN yes | pecl install xdebug
RUN echo "zend_extension=$(find /usr/local/lib/php/extensions/ -name xdebug.so)" > /usr/local/etc/php/conf.d/xdebug.ini
```
#### Docker Compose

This is an incomplete Docker Compose configuration showing all relevant settings for the debugproxy:

```
services:
  debugproxy:
    image: ghcr.io/sachera/flow-debugproxy:latest
    volumes:
      - neos_data_tempory:/neos/Data/Temporary:ro
    environment:
      # This MUST be the IP address of the IDE (your computer)
      IDE_PORT: 9003
      # This is the default value, need to match the xdebug.client_port and FLOW_CONTEXT environment variable
      XDEBUG: Docker/Testing:9001,Docker/Development:9002
      # must match the path used in the volume
      LOCAL_ROOT: /neos
      # Use this to enable verbose debugging on the proxy
      #ADDITIONAL_ARGS: "-vv --debug"
    networks:
      - backend

  # This is your application containers, you need to link it to the proxy
  app:
    # The proxy need an access to the project files, to be able to do the path mapping
    # make sure the path is the one actually used by neos and exists in the container
    # if it is created by this command neos won't be able to write any temporary cache data due to right issues!
    volumes:
      neos_data_tempory:/app/Data/Temporary:rw,cached
      
volumes:
  neos_data_temporary: {}
```

When running the debugger make sure to include interpreter options for xdebug to tell it about your debug proxy. For example using the above compose file when debugging a test in the Docker/Testing context you would use:

```
-dxdebug.client_host=debugproxy -dxdebug.client_port=9001
```

**Depending on your IDE set this setting as late as possible!**

IntelliJ/PHPStorm for example set these command line options on their own, overriding them if you set them in your xdebug.ini. You will need to add them to the configuration of each actual test to make sure these settings have precedence!

**Options summary:**
* `IDE_IP` The primary local W-/LAN IP of your machine where your IDE runs on, defaults to docker.host.internal
* `IDE_PORT` The Port your IDE is listening for incoming xdebug connections. (The port the debug proxy will try to connect to)
* `XDEBUG` The flow context to port mapping. Based on the port xdebug connects to the context will be determined by this container
* `LOCAL_ROOT` The path where the Data/Temporary directory will be mounted to. Used to determine the path mapping
* `FRAMEWORK` Currently supported values: `flow` and `dummy`
* `ADDITIONAL_ARGS` For any additional argument like verbosity flags (`-vv`) or debug mode (`--debug`) (or both)

**Debugging the debugger**

Start the debug proxy with verbose flags if it does not connect to your IDE.
The debug proxy does not quit after stopping the process that started it.
You have to kill it in the container manually.

Hint:

If you use the env variable `FLOW_PATH_TEMPORARY_BASE`, please be sure to keep
`Data/Temporary` inside the path, without this the mapper will not detect the
proxy classes.

```
FLOW_PATH_TEMPORARY_BASE=/tmp/flow/Data/Temporary
```

Using with --framework dummy
----------------------------

If your debugging target is the code generated by Flow's AOP Framework then you can start the debugging proxy with `--framework dummy`.

In that case it won't remap from the generated code to your source but "pass through" the debugger steps.
To see what's going on you have to have the generated code in a folder visible to your IDE (in your project).
You can either abstain from `FLOW_PATH_TEMPORARY_BASE` or set it to a path that is in your IDE's project.

Acknowledgments
---------------

Development sponsored by [ttree ltd - neos solution provider](http://ttree.ch).

This project is highly inspired by the PHP based Debug proxy:
https://github.com/sandstorm/debugproxy thanks to the Sandstorm team. The goal
of the Go version of the proxy is to solve the performance issue that the PHP
version has.

We try our best to craft this package with a lots of love, we are open to
sponsoring, support request, ... just contact us.

License
-------

Licensed under MIT, see [LICENSE](LICENSE)
